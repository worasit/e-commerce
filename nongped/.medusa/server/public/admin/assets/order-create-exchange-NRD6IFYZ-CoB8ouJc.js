import{I as ve}from"./chunk-QJ6SBVJ2-CYv6OEFt.js";import{R as He,O as Fe,C as Le}from"./chunk-P3DRE4IY-BKPx0O9G.js";import{M as ye}from"./chunk-LHJ6JQGA-DRKvlJmt.js";import{c as ze,d as Be,e as Ve,u as Ue,f as Ge,g as $e,h as Xe,i as Qe,j as Je,k as Ke,l as Ze,m as We,n as Ye,o as et,p as tt,q as st}from"./chunk-HVKSIETZ-DMs27n1G.js";import{g as Ie}from"./chunk-PXZ7QYKX-DZ_CHK12.js";import{D as nt}from"./chunk-AMJSV3NG-DPKI1Y1t.js";import{c as it,o as at}from"./chunk-P75BH6ZT-BCyrBbuC.js";import{a as K}from"./chunk-FSMQADBD-DQ6u7KYm.js";import{a5 as O,R as ot,u as rt,b as V,aK as lt,aN as dt,r as j,j as e,a8 as ct,a9 as ut,t as R,H as ce,I as ee,w as b,ab as mt,B as Z,b8 as pt,y as Ne,T as G,de as ht,aZ as Se,x as de,A as Ee,X as me,s as Ce,dg as ft}from"./index-CJZ0utKv.js";import{P as Pe,a as Me}from"./chunk-RERSP5B2-CY1D6Z0R.js";import{C as te}from"./chunk-BNH57GBH-aOoD9B19.js";import{c as pe}from"./chunk-MWVM4TYO-bKUcYSnf.js";import{u as ke,D as Ae}from"./chunk-W34HOKLZ-C3c-DWJt.js";import"./lodash-r6m_RtXk.js";import{u as we}from"./chunk-C76H5USB-BpSyh2up.js";import"./chunk-VDP2AG2T-lTWCWF6Z.js";import"./chunk-KHOKHZC6-CwL1LPjm.js";import{u as De}from"./chunk-STLKFKTM-Psl18YG9.js";import{K as xt}from"./chunk-6HTZNHPT-DAtm5oB_.js";import{R as X,u as gt,a as Re,S as U}from"./chunk-KL22UNUW-BusAggzY.js";import{P as he}from"./pencil-square-CANgz5Uf.js";import{u as _t}from"./use-prompt-Bi7FceQH.js";import{D as bt}from"./document-text-DhZQsG8W.js";import{X as Te}from"./x-circle-DvpCPk2O.js";import{C as fe}from"./currency-input-BHCL_9VI.js";import{A as qe}from"./alert-B1fSnlBT.js";import{C as se}from"./checkbox-C144Yjdp.js";import{c as Oe}from"./index-B1m4_RH3.js";import"./Trans-CyKh6hGN.js";import"./chunk-P3UUX2T6-iZ3txzdJ.js";import"./x-mark-mini-ysYOSGAt.js";import"./triangles-mini-CxMQ-XTT.js";import"./plus-mini-BdX2C9J6.js";import"./chunk-YEDAFXMB-CRa1E9kp.js";import"./chunk-AOFGTNG6-Do1n8oDW.js";import"./chunk-WX2SMNCD-gsBa7lx4.js";import"./command-bar-DKNd8HCa.js";import"./index-poKGl5ZU.js";import"./chunk-HG5TSG3K-BtN5fyyg.js";import"./format-B_KHsbPT.js";import"./date-picker-Celg6WpL.js";import"./clsx-B-dksMZM.js";import"./popover-Dq5pafWl.js";import"./triangle-left-mini-DJxp3gb4.js";import"./prompt-Di3JszOJ.js";import"./index.esm-Ls_FBjZZ.js";var jt=O.object({inbound_items:O.array(O.object({item_id:O.string(),quantity:O.number(),reason_id:O.string().nullish(),note:O.string().nullish()})),outbound_items:O.array(O.object({item_id:O.string(),quantity:O.number()})),location_id:O.string().optional(),inbound_option_id:O.string().nullish(),outbound_option_id:O.string().nullish(),send_notification:O.boolean().optional()}),J=Oe(),vt=n=>{const{t:l}=V();return j.useMemo(()=>[J.display({id:"select",header:({table:o})=>e.jsx(se,{checked:o.getIsSomePageRowsSelected()?"indeterminate":o.getIsAllPageRowsSelected(),onCheckedChange:r=>o.toggleAllPageRowsSelected(!!r)}),cell:({row:o})=>{const r=o.getCanSelect();return e.jsx(se,{disabled:!r,checked:o.getIsSelected(),onCheckedChange:a=>o.toggleSelected(!!a),onClick:a=>{a.stopPropagation()}})}}),J.display({id:"product",header:()=>e.jsx(Pe,{}),cell:({row:o})=>e.jsx(Me,{product:{thumbnail:o.original.thumbnail,title:o.original.product_title}})}),J.accessor("variant.sku",{header:l("fields.sku"),cell:({getValue:o})=>o()||"-"}),J.accessor("variant.title",{header:l("fields.variant")}),J.accessor("quantity",{header:()=>e.jsx("div",{className:"flex size-full items-center overflow-hidden text-right",children:e.jsx("span",{className:"truncate",children:l("fields.quantity")})}),cell:({getValue:o,row:r})=>Ie(r.original)}),J.accessor("refundable_total",{header:()=>e.jsx("div",{className:"flex size-full items-center justify-end overflow-hidden text-right",children:e.jsx("span",{className:"truncate",children:l("fields.price")})}),cell:({getValue:o})=>{const r=o()||0,a=K(r,n);return e.jsx("div",{className:"flex size-full items-center justify-end overflow-hidden text-right",children:e.jsx("span",{className:"truncate",children:a})})}})],[l,n])},yt=()=>{const{t:n}=V();return[{key:"created_at",label:n("fields.createdAt"),type:"date"},{key:"updated_at",label:n("fields.updatedAt"),type:"date"}]},It=({pageSize:n=50,prefix:l})=>{const o=we(["q","offset","order","created_at","updated_at"],l),{offset:r,created_at:a,updated_at:m,...g}=o;return{searchParams:{...g,limit:n,offset:r?Number(r):0,created_at:a?JSON.parse(a):void 0,updated_at:m?JSON.parse(m):void 0},raw:o}},ne=50,xe="rit",Nt=({onSelectionChange:n,selectedItems:l,items:o,currencyCode:r})=>{const{t:a}=V(),[m,g]=j.useState(l.reduce((f,I)=>(f[I]=!0,f),{})),N=f=>{const I=typeof f=="function"?f(m):f;g(I),n(Object.keys(I))},{searchParams:v,raw:S}=It({pageSize:ne,prefix:xe}),P=j.useMemo(()=>{const{order:f,offset:I,limit:E,q:L,created_at:H,updated_at:$}=v;let q=o;if(L&&(q=q.filter(F=>{var C;return F.product_title.toLowerCase().includes(L.toLowerCase())||F.variant_title.toLowerCase().includes(L.toLowerCase())||((C=F.variant_sku)==null?void 0:C.toLowerCase().includes(L.toLowerCase()))})),f){const F=f[0]==="-"?"desc":"asc",C=f.replace("-","");q=St(q,C,F)}return H&&(q=ge(q,H,"created_at")),$&&(q=ge(q,$,"updated_at")),q.slice(I,I+E)},[o,r,v]),w=vt(r),T=yt(),{table:k}=ke({data:P,columns:w,count:P.length,enablePagination:!0,getRowId:f=>f.id,pageSize:ne,enableRowSelection:f=>Ie(f.original)>0,rowSelection:{state:m,updater:N}});return e.jsx("div",{className:"flex size-full flex-col overflow-hidden",children:e.jsx(Ae,{table:k,columns:w,pageSize:ne,count:P.length,filters:T,pagination:!0,layout:"fill",search:!0,orderBy:[{key:"product_title",label:a("fields.product")},{key:"variant_title",label:a("fields.variant")},{key:"sku",label:a("fields.sku")}],prefix:xe,queryObject:S})})},St=(n,l,o)=>n.sort((r,a)=>{let m,g;return l==="product_title"?(m=r.product_title,g=a.product_title):l==="variant_title"?(m=r.variant_title,g=a.variant_title):l==="sku"&&(m=r.variant_sku,g=a.variant_sku),m<g?o==="asc"?-1:1:m>g?o==="asc"?1:-1:0}),ge=(n,l,o)=>{const{gt:r,gte:a,lt:m,lte:g}=l;return n.filter(N=>{const v=new Date(N[o]);let S=!0;return r&&(S=S&&v>new Date(r)),a&&(S=S&&v>=new Date(a)),m&&(S=S&&v<new Date(m)),g&&(S=S&&v<=new Date(g)),S})};function Et({item:n,previewItem:l,currencyCode:o,form:r,onRemove:a,onUpdate:m,index:g}){const{t:N}=V(),{return_reasons:v=[]}=ht({fields:"+label"}),S=r.watch(`inbound_items.${g}`),P=typeof S.reason_id=="string",w=typeof S.note=="string";return e.jsxs("div",{className:"bg-ui-bg-subtle shadow-elevation-card-rest my-2 rounded-xl ",children:[e.jsxs("div",{className:"flex flex-col items-center gap-x-2 gap-y-2 p-3 text-sm md:flex-row",children:[e.jsxs("div",{className:"flex flex-1 items-center gap-x-3",children:[e.jsx(Se,{src:n.thumbnail}),e.jsxs("div",{className:"flex flex-col",children:[e.jsxs("div",{children:[e.jsxs(G,{className:"txt-small",as:"span",weight:"plus",children:[n.title," "]}),n.variant_sku&&e.jsxs("span",{children:["(",n.variant_sku,")"]})]}),e.jsx(G,{as:"div",className:"text-ui-fg-subtle txt-small",children:n.product_title})]})]}),e.jsxs("div",{className:"flex flex-1 justify-between",children:[e.jsxs("div",{className:"flex flex-grow items-center gap-2",children:[e.jsx(b.Field,{control:r.control,name:`inbound_items.${g}.quantity`,render:({field:T})=>e.jsxs(b.Item,{children:[e.jsx(b.Control,{children:e.jsx(de,{...T,className:"bg-ui-bg-base txt-small w-[67px] rounded-lg",min:1,max:n.quantity,type:"number",onBlur:k=>{const f=k.target.value,I=f===""?null:Number(f);T.onChange(I),I&&m({quantity:I})}})}),e.jsx(b.ErrorMessage,{})]})}),e.jsx(G,{className:"txt-small text-ui-fg-subtle",children:N("fields.qty")})]}),e.jsx("div",{className:"text-ui-fg-subtle txt-small mr-2 flex flex-shrink-0",children:e.jsx(ye,{currencyCode:o,amount:l.return_requested_total})}),e.jsx(Ee,{groups:[{actions:[!P&&{label:N("actions.addReason"),onClick:()=>r.setValue(`inbound_items.${g}.reason_id`,""),icon:e.jsx(Le,{})},!w&&{label:N("actions.addNote"),onClick:()=>r.setValue(`inbound_items.${g}.note`,""),icon:e.jsx(bt,{})},{label:N("actions.remove"),onClick:a,icon:e.jsx(Te,{})}].filter(Boolean)}]})]})]}),e.jsxs(e.Fragment,{children:[P&&e.jsxs("div",{className:"grid grid-cols-1 gap-2 p-3 md:grid-cols-2",children:[e.jsxs("div",{children:[e.jsx(b.Label,{children:N("orders.returns.reason")}),e.jsx(b.Hint,{className:"!mt-1",children:N("orders.returns.reasonHint")})]}),e.jsxs("div",{className:"flex items-center gap-1",children:[e.jsx("div",{className:"flex-grow",children:e.jsx(b.Field,{control:r.control,name:`inbound_items.${g}.reason_id`,render:({field:{ref:T,value:k,onChange:f,...I}})=>e.jsxs(b.Item,{children:[e.jsx(b.Control,{children:e.jsx(te,{className:"bg-ui-bg-field-component hover:bg-ui-bg-field-component-hover",value:k,onChange:E=>{m({reason_id:E}),f(E)},...I,options:v.map(E=>({label:E.label,value:E.id}))})}),e.jsx(b.ErrorMessage,{})]})})}),e.jsx(ee,{type:"button",className:"flex-shrink",variant:"transparent",onClick:()=>{r.setValue(`inbound_items.${g}.reason_id`,null),m({reason_id:null})},children:e.jsx(me,{className:"text-ui-fg-muted"})})]})]}),w&&e.jsxs("div",{className:"grid grid-cols-1 gap-2 p-3 md:grid-cols-2",children:[e.jsxs("div",{children:[e.jsx(b.Label,{children:N("orders.returns.note")}),e.jsx(b.Hint,{className:"!mt-1",children:N("orders.returns.noteHint")})]}),e.jsxs("div",{className:"flex items-center gap-1",children:[e.jsx("div",{className:"flex-grow",children:e.jsx(b.Field,{control:r.control,name:`inbound_items.${g}.note`,render:({field:{ref:T,...k}})=>e.jsxs(b.Item,{children:[e.jsx(b.Control,{children:e.jsx(de,{...k,onBlur:()=>{k.onChange(k.value),m({internal_note:k.value})},className:"bg-ui-bg-field-component hover:bg-ui-bg-field-component-hover"})}),e.jsx(b.ErrorMessage,{})]})})}),e.jsx(ee,{type:"button",className:"flex-shrink",variant:"transparent",onClick:()=>{r.setValue(`inbound_items.${g}.note`,null),m({internal_note:null})},children:e.jsx(me,{className:"text-ui-fg-muted"})})]})]})]})]})}var ie=[],_e=[],Ct=({order:n,preview:l,exchange:o,form:r,orderReturn:a})=>{var D;const{t:m}=V(),{setIsOpen:g}=Re(),[N,v]=j.useState({}),{mutateAsync:S}=at((D=l==null?void 0:l.order_change)==null?void 0:D.return_id,n.id),{mutateAsync:P}=Xe(o.id,n.id),{mutateAsync:w}=Qe(o.id,n.id),{mutateAsync:T}=Je(o.id,n.id),{mutateAsync:k}=Ke(o.id,n.id),{mutateAsync:f}=Ze(o.id,n.id),I=j.useMemo(()=>{var u;return(u=l==null?void 0:l.items)==null?void 0:u.filter(s=>{var i;return!!((i=s.actions)!=null&&i.find(t=>t.exchange_id===o.id))})},[l.items]),E=I.filter(u=>{var s;return!!((s=u.actions)!=null&&s.find(i=>i.action==="RETURN_ITEM"))}),L=j.useMemo(()=>{var u;return new Map((u=n==null?void 0:n.items)==null?void 0:u.map(s=>[s.id,s]))},[n.items]),H=r.watch("location_id"),{stock_locations:$=[]}=pt({limit:999}),{shipping_options:q=[]}=De({limit:999,fields:"*prices,+service_zone.fulfillment_set.location.id",stock_location_id:H},{enabled:!!H}),F=q.filter(u=>!!u.rules.find(s=>s.attribute==="is_return"&&s.value==="true")),{fields:C,append:Q,remove:z,update:B}=Ne({name:"inbound_items",control:r.control}),p=j.useMemo(()=>new Map(I.map(u=>[u.id,u])),[I,C]);j.useEffect(()=>{const u={};E.forEach(s=>{var t,d;const i=C.findIndex(h=>h.item_id===s.id);if(u[s.id]=!0,i>-1){if(C[i].quantity!==s.detail.return_requested_quantity){const h=(t=s.actions)==null?void 0:t.find(M=>M.action==="RETURN_ITEM");B(i,{...C[i],quantity:s.detail.return_requested_quantity,note:h==null?void 0:h.internal_note,reason_id:(d=h==null?void 0:h.details)==null?void 0:d.reason_id})}}else Q({item_id:s.id,quantity:s.detail.return_requested_quantity},{shouldFocus:!1})}),C.forEach((s,i)=>{s.item_id in u||z(i)})},[I]),j.useEffect(()=>{const u=l.shipping_methods.find(s=>{var i;return(i=s.actions)==null?void 0:i.find(t=>t.action==="SHIPPING_ADD"&&!!t.return_id)});u?r.setValue("inbound_option_id",u.shipping_option_id):r.setValue("inbound_option_id",null)},[l.shipping_methods]),j.useEffect(()=>{r.setValue("location_id",a==null?void 0:a.location_id)},[a]);const x=!C.length,c=async()=>{var u,s,i;ie.length&&await T({items:ie.map(t=>({id:t,quantity:1}))},{onError:t=>{R.error(t.message)}});for(const t of _e){const d=(i=(s=(u=I.find(h=>h.id===t))==null?void 0:u.actions)==null?void 0:s.find(h=>h.action==="RETURN_ITEM"))==null?void 0:i.id;d&&await f(d,{onError:h=>{R.error(h.message)}})}g("inbound-items",!1)},_=async u=>{await S({location_id:u})},y=async u=>{const i=l.shipping_methods.filter(t=>{var d;return(d=t.actions)==null?void 0:d.find(h=>h.action==="SHIPPING_ADD"&&!!h.return_id)}).filter(Boolean).map(t=>{var h;const d=(h=t.actions)==null?void 0:h.find(M=>M.action==="SHIPPING_ADD"&&!!M.return_id);if(d)return w(d.id)});await Promise.all(i),await P({shipping_option_id:u},{onError:t=>{R.error(t.message)}})},A=j.useMemo(()=>H?!C.map(s=>{var t,d;const i=L.get(s.item_id);return!(i!=null&&i.variant_id)||!(i!=null&&i.variant)||!((t=i.variant)!=null&&t.manage_inventory)?!0:(d=N[i.variant_id])==null?void 0:d.find(h=>h.location_id===H)}).every(Boolean):!1,[C,N,H]);return j.useEffect(()=>{(async()=>{const s={};if(!C.length)return s;const i=C.map(d=>d==null?void 0:d.variant_id).filter(Boolean);return(await Ce.admin.productVariant.list({id:i},{fields:"*inventory,*inventory.location_levels"})).variants.forEach(d=>{var h,M;s[d.id]=((M=(h=d.inventory)==null?void 0:h[0])==null?void 0:M.location_levels)||[]}),s})().then(s=>{v(s)})},[C]),e.jsxs("div",{children:[e.jsxs("div",{className:"mt-8 flex items-center justify-between",children:[e.jsx(ce,{level:"h2",children:m("orders.returns.inbound")}),e.jsxs(U,{id:"inbound-items",children:[e.jsx(U.Trigger,{asChild:!0,children:e.jsx("a",{className:"focus-visible:shadow-borders-focus transition-fg txt-compact-small-plus cursor-pointer text-blue-500 outline-none hover:text-blue-400",children:m("actions.addItems")})}),e.jsxs(U.Content,{children:[e.jsx(U.Header,{}),e.jsx(Nt,{items:n.items,selectedItems:C.map(u=>u.item_id),currencyCode:n.currency_code,onSelectionChange:u=>{const s=C.map(i=>i.item_id);ie=u.filter(i=>!s.includes(i)),_e=s.filter(i=>!u.includes(i))}}),e.jsx(U.Footer,{children:e.jsx("div",{className:"flex w-full items-center justify-end gap-x-4",children:e.jsxs("div",{className:"flex items-center justify-end gap-x-2",children:[e.jsx(X.Close,{asChild:!0,children:e.jsx(Z,{type:"button",variant:"secondary",size:"small",children:m("actions.cancel")})}),e.jsx(Z,{type:"submit",variant:"primary",size:"small",role:"button",onClick:async()=>await c(),children:m("actions.save")},"submit-button")]})})})]})]})]}),x&&e.jsx(ve,{}),C.map((u,s)=>p.get(u.item_id)&&L.get(u.item_id)&&e.jsx(Et,{item:L.get(u.item_id),previewItem:p.get(u.item_id),currencyCode:n.currency_code,form:r,onRemove:()=>{var t,d,h;const i=(h=(d=(t=I.find(M=>M.id===u.item_id))==null?void 0:t.actions)==null?void 0:d.find(M=>M.action==="RETURN_ITEM"))==null?void 0:h.id;i&&f(i,{onError:M=>{R.error(M.message)}})},onUpdate:i=>{var d,h;const t=(h=(d=I.find(M=>M.id===u.item_id))==null?void 0:d.actions)==null?void 0:h.find(M=>M.action==="RETURN_ITEM");t&&k({...i,actionId:t.id},{onError:M=>{var W,ue;(W=t.details)!=null&&W.quantity&&i.quantity&&r.setValue(`inbound_items.${s}.quantity`,(ue=t.details)==null?void 0:ue.quantity),R.error(M.message)}})},index:s},u.id)),!x&&e.jsxs("div",{className:"mt-8 flex flex-col gap-y-4",children:[e.jsxs("div",{className:"grid grid-cols-1 gap-2 md:grid-cols-2",children:[e.jsxs("div",{children:[e.jsx(b.Label,{children:m("orders.returns.location")}),e.jsx(b.Hint,{className:"!mt-1",children:m("orders.returns.locationHint")})]}),e.jsx(b.Field,{control:r.control,name:"location_id",render:({field:{value:u,onChange:s,...i}})=>e.jsx(b.Item,{children:e.jsx(b.Control,{children:e.jsx(te,{...i,value:u??void 0,onChange:t=>{s(t),_(t)},options:($??[]).map(t=>({label:t.name,value:t.id}))})})})})]}),e.jsxs("div",{className:"grid grid-cols-1 gap-2 md:grid-cols-2",children:[e.jsxs("div",{children:[e.jsxs(b.Label,{children:[m("orders.returns.inboundShipping"),e.jsxs(G,{size:"small",leading:"compact",className:"text-ui-fg-muted ml-1 inline",children:["(",m("fields.optional"),")"]})]}),e.jsx(b.Hint,{className:"!mt-1",children:m("orders.returns.inboundShippingHint")})]}),e.jsx(b.Field,{control:r.control,name:"inbound_option_id",render:({field:{value:u,onChange:s,...i}})=>e.jsx(b.Item,{children:e.jsx(b.Control,{children:e.jsx(te,{value:u??void 0,onChange:t=>{s(t),t&&y(t)},...i,options:F.map(t=>({label:t.name,value:t.id})),disabled:!H,noResultsPlaceholder:e.jsx(He,{})})})})})]})]}),A&&e.jsxs(qe,{variant:"warning",dismissible:!0,className:"mt-4 p-5",children:[e.jsx("div",{className:"text-ui-fg-subtle txt-small pb-2 font-medium leading-[20px]",children:m("orders.returns.noInventoryLevel")}),e.jsx(G,{className:"text-ui-fg-subtle txt-small leading-normal",children:m("orders.returns.noInventoryLevelDesc")})]})]})},Y=Oe(),Pt=n=>{const{t:l}=V();return j.useMemo(()=>[Y.display({id:"select",header:({table:o})=>e.jsx(se,{checked:o.getIsSomePageRowsSelected()?"indeterminate":o.getIsAllPageRowsSelected(),onCheckedChange:r=>o.toggleAllPageRowsSelected(!!r)}),cell:({row:o})=>{const r=o.getCanSelect();return e.jsx(se,{disabled:!r,checked:o.getIsSelected(),onCheckedChange:a=>o.toggleSelected(!!a),onClick:a=>{a.stopPropagation()}})}}),Y.display({id:"product",header:()=>e.jsx(Pe,{}),cell:({row:o})=>e.jsx(Me,{product:o.original.product})}),Y.accessor("sku",{header:l("fields.sku"),cell:({getValue:o})=>o()||"-"}),Y.accessor("title",{header:l("fields.title")})],[l,n])},Mt=()=>{const{t:n}=V();return[{key:"created_at",label:n("fields.createdAt"),type:"date"},{key:"updated_at",label:n("fields.updatedAt"),type:"date"}]},kt=({pageSize:n=50,prefix:l})=>{const o=we(["q","offset","order","created_at","updated_at"],l),{offset:r,created_at:a,updated_at:m,...g}=o;return{searchParams:{...g,limit:n,offset:r?Number(r):0,created_at:a?JSON.parse(a):void 0,updated_at:m?JSON.parse(m):void 0},raw:o}},ae=50,be="rit",At=({onSelectionChange:n,selectedItems:l,currencyCode:o})=>{const{t:r}=V(),[a,m]=j.useState(l.reduce((f,I)=>(f[I]=!0,f),{})),g=f=>{const I=typeof f=="function"?f(a):f;m(I),n(Object.keys(I))},{searchParams:N,raw:v}=kt({pageSize:ae,prefix:be}),{variants:S=[],count:P}=ft({...N,fields:"*inventory_items.inventory.location_levels,+inventory_quantity"}),w=Pt(o),T=Mt(),{table:k}=ke({data:S,columns:w,count:P,enablePagination:!0,getRowId:f=>f.id,pageSize:ae,enableRowSelection:f=>!0,rowSelection:{state:a,updater:g}});return e.jsx("div",{className:"flex size-full flex-col overflow-hidden",children:e.jsx(Ae,{table:k,columns:w,pageSize:ae,count:P,filters:T,pagination:!0,layout:"fill",search:!0,orderBy:[{key:"product_id",label:r("fields.product")},{key:"title",label:r("fields.title")},{key:"sku",label:r("fields.sku")}],prefix:be,queryObject:v})})};function wt({previewItem:n,currencyCode:l,form:o,onRemove:r,onUpdate:a,index:m}){const{t:g}=V();return e.jsx("div",{className:"bg-ui-bg-subtle shadow-elevation-card-rest my-2 rounded-xl ",children:e.jsxs("div",{className:"flex flex-col items-center gap-x-2 gap-y-2 p-3 text-sm md:flex-row",children:[e.jsxs("div",{className:"flex flex-1 items-center gap-x-3",children:[e.jsx(Se,{src:n.thumbnail}),e.jsxs("div",{className:"flex flex-col",children:[e.jsxs("div",{children:[e.jsxs(G,{className:"txt-small",as:"span",weight:"plus",children:[n.title," "]}),n.variant_sku&&e.jsxs("span",{children:["(",n.variant_sku,")"]})]}),e.jsx(G,{as:"div",className:"text-ui-fg-subtle txt-small",children:n.product_title})]})]}),e.jsxs("div",{className:"flex flex-1 justify-between",children:[e.jsxs("div",{className:"flex flex-grow items-center gap-2",children:[e.jsx(b.Field,{control:o.control,name:`outbound_items.${m}.quantity`,render:({field:N})=>e.jsxs(b.Item,{children:[e.jsx(b.Control,{children:e.jsx(de,{...N,className:"bg-ui-bg-base txt-small w-[67px] rounded-lg",min:1,type:"number",onBlur:v=>{const S=v.target.value,P=S===""?null:Number(S);N.onChange(P),P&&a({quantity:P})}})}),e.jsx(b.ErrorMessage,{})]})}),e.jsx(G,{className:"txt-small text-ui-fg-subtle",children:g("fields.qty")})]}),e.jsx("div",{className:"text-ui-fg-subtle txt-small mr-2 flex flex-shrink-0",children:e.jsx(ye,{currencyCode:l,amount:n.total})}),e.jsx(Ee,{groups:[{actions:[{label:g("actions.remove"),onClick:r,icon:e.jsx(Te,{})}].filter(Boolean)}]})]})]})})}var oe=[],je=[],Dt=({order:n,preview:l,exchange:o,form:r})=>{const{t:a}=V(),{setIsOpen:m}=Re(),[g,N]=j.useState({}),{shipping_options:v=[]}=De({limit:999,fields:"*prices,+service_zone.fulfillment_set.location.id"}),{mutateAsync:S}=We(o.id,n.id),{mutateAsync:P}=Ye(o.id,n.id),{mutateAsync:w}=et(o.id,n.id),{mutateAsync:T}=tt(o.id,n.id),{mutateAsync:k}=st(o.id,n.id),f=j.useMemo(()=>{var p;return(p=l==null?void 0:l.items)==null?void 0:p.filter(x=>{var c;return!!((c=x.actions)!=null&&c.find(_=>_.exchange_id===o.id&&_.action==="ITEM_ADD"))})},[l.items]),I=j.useMemo(()=>{var p;return new Map((p=n==null?void 0:n.items)==null?void 0:p.map(x=>[x.variant_id,x]))},[n.items]),{fields:E,append:L,remove:H,update:$}=Ne({name:"outbound_items",control:r.control}),q=j.useMemo(()=>new Map(f.map(p=>[p.variant_id,p])),[f,E]);j.useEffect(()=>{const p={};f.forEach(x=>{const c=E.findIndex(_=>_.item_id===x.id);p[x.id]=!0,c>-1?E[c].quantity!==x.detail.quantity&&$(c,{...E[c],quantity:x.detail.quantity}):L({item_id:x.id,quantity:x.detail.quantity,variant_id:x.variant_id},{shouldFocus:!1})}),E.forEach((x,c)=>{x.item_id in p||H(c)})},[f]);const F=r.watch("location_id"),C=!E.length,Q=async()=>{var p,x;oe.length&&await w({items:oe.map(c=>({variant_id:c,quantity:1}))},{onError:c=>{R.error(c.message)}});for(const c of je){const _=(x=(p=f.find(y=>y.variant_id===c))==null?void 0:p.actions)==null?void 0:x.find(y=>y.action==="ITEM_ADD");_!=null&&_.id&&await k(_==null?void 0:_.id,{onError:y=>{R.error(y.message)}})}m("outbound-items",!1)};j.useEffect(()=>{const p=l.shipping_methods.find(x=>{var c;return!!((c=x.actions)!=null&&c.find(_=>_.action==="SHIPPING_ADD"&&!_.return_id))});p?r.setValue("outbound_option_id",p.shipping_option_id):r.setValue("outbound_option_id",null)},[l.shipping_methods]);const z=async p=>{const c=l.shipping_methods.filter(_=>{var y;return!!((y=_.actions)!=null&&y.find(A=>A.action==="SHIPPING_ADD"&&!A.return_id))}).filter(Boolean).map(_=>{var A;const y=(A=_.actions)==null?void 0:A.find(D=>D.action==="SHIPPING_ADD"&&!D.return_id);if(y)return P(y.id)});await Promise.all(c),await S({shipping_option_id:p},{onError:_=>{R.error(_.message)}})},B=j.useMemo(()=>F?!E.map(x=>{var _,y;const c=I.get(x.variant_id);return!(c!=null&&c.variant_id)||!(c!=null&&c.variant)||!((_=c.variant)!=null&&_.manage_inventory)?!0:(y=g[c.variant_id])==null?void 0:y.find(A=>A.location_id===F)}).every(Boolean):!1,[E,g,F]);return j.useEffect(()=>{(async()=>{const x={};if(!E.length)return x;const c=E.map(y=>y==null?void 0:y.variant_id).filter(Boolean);return(await Ce.admin.productVariant.list({id:c},{fields:"*inventory,*inventory.location_levels"})).variants.forEach(y=>{var A,D;x[y.id]=((D=(A=y.inventory)==null?void 0:A[0])==null?void 0:D.location_levels)||[]}),x})().then(x=>{N(x)})},[E]),e.jsxs("div",{children:[e.jsxs("div",{className:"mt-8 flex items-center justify-between",children:[e.jsx(ce,{level:"h2",children:a("orders.returns.outbound")}),e.jsxs(U,{id:"outbound-items",children:[e.jsx(U.Trigger,{asChild:!0,children:e.jsx("a",{className:"focus-visible:shadow-borders-focus transition-fg txt-compact-small-plus cursor-pointer text-blue-500 outline-none hover:text-blue-400",children:a("actions.addItems")})}),e.jsxs(U.Content,{children:[e.jsx(U.Header,{}),e.jsx(At,{selectedItems:E.map(p=>p.variant_id),currencyCode:n.currency_code,onSelectionChange:p=>{const x=E.map(c=>c.variant_id);oe=p.filter(c=>!x.includes(c)),je=x.filter(c=>!p.includes(c))}}),e.jsx(U.Footer,{children:e.jsx("div",{className:"flex w-full items-center justify-end gap-x-4",children:e.jsxs("div",{className:"flex items-center justify-end gap-x-2",children:[e.jsx(X.Close,{asChild:!0,children:e.jsx(Z,{type:"button",variant:"secondary",size:"small",children:a("actions.cancel")})}),e.jsx(Z,{type:"submit",variant:"primary",size:"small",role:"button",onClick:async()=>await Q(),children:a("actions.save")},"submit-button")]})})})]})]})]}),C&&e.jsx(ve,{}),E.map((p,x)=>q.get(p.variant_id)&&e.jsx(wt,{previewItem:q.get(p.variant_id),currencyCode:n.currency_code,form:r,onRemove:()=>{var _,y,A;const c=(A=(y=(_=f.find(D=>D.id===p.item_id))==null?void 0:_.actions)==null?void 0:y.find(D=>D.action==="ITEM_ADD"))==null?void 0:A.id;c&&k(c,{onError:D=>{R.error(D.message)}})},onUpdate:c=>{var y,A,D;const _=(D=(A=(y=f.find(u=>u.id===p.item_id))==null?void 0:y.actions)==null?void 0:A.find(u=>u.action==="ITEM_ADD"))==null?void 0:D.id;_&&T({...c,actionId:_},{onError:u=>{R.error(u.message)}})},index:x},p.id)),!C&&e.jsx("div",{className:"mt-8 flex flex-col gap-y-4",children:e.jsxs("div",{className:"grid grid-cols-1 gap-2 md:grid-cols-2",children:[e.jsxs("div",{children:[e.jsx(b.Label,{children:a("orders.exchanges.outboundShipping")}),e.jsx(b.Hint,{className:"!mt-1",children:a("orders.exchanges.outboundShippingHint")})]}),e.jsx(b.Field,{control:r.control,name:"outbound_option_id",render:({field:{value:p,onChange:x,...c}})=>e.jsx(b.Item,{children:e.jsx(b.Control,{children:e.jsx(te,{noResultsPlaceholder:e.jsx(Fe,{}),value:p??void 0,onChange:_=>{x(_),_&&z(_)},...c,options:v.map(_=>({label:_.name,value:_.id})),disabled:!v.length})})})})]})}),B&&e.jsxs(qe,{variant:"warning",dismissible:!0,className:"mt-4 p-5",children:[e.jsx("div",{className:"text-ui-fg-subtle txt-small pb-2 font-medium leading-[20px]",children:a("orders.returns.noInventoryLevel")}),e.jsx(G,{className:"text-ui-fg-subtle txt-small leading-normal",children:a("orders.returns.noInventoryLevelDesc")})]})]})},re=!1,Rt=({order:n,preview:l,exchange:o,orderReturn:r})=>{const{t:a}=V(),{handleSuccess:m}=gt(),[g,N]=j.useState(!1),[v,S]=j.useState(!1),[P,w]=j.useState(0),[T,k]=j.useState(0),{mutateAsync:f,isPending:I}=Ve(o.id,n.id),{mutateAsync:E,isPending:L}=Ue(o.id,n.id),{mutateAsync:H,isPending:$}=Ge(o.id,n.id),{mutateAsync:q,isPending:F}=$e(o.id,n.id),C=I||L||F||$,Q=j.useMemo(()=>{var s;return(s=l==null?void 0:l.items)==null?void 0:s.filter(i=>{var t;return!!((t=i.actions)!=null&&t.find(d=>d.exchange_id===o.id))})},[l.items]),z=Q.filter(s=>{var i;return!!((i=s.actions)!=null&&i.find(t=>t.action==="RETURN_ITEM"))}),B=Q.filter(s=>{var i;return!!((i=s.actions)!=null&&i.find(t=>t.action==="ITEM_ADD"))}),p=ct({defaultValues:()=>{const s=l.shipping_methods.find(t=>{var d;return!!((d=t.actions)!=null&&d.find(h=>h.action==="SHIPPING_ADD"&&!!h.return_id))}),i=l.shipping_methods.find(t=>{var d;return!!((d=t.actions)!=null&&d.find(h=>h.action==="SHIPPING_ADD"&&!h.return_id))});return Promise.resolve({inbound_items:z.map(t=>{var h,M;const d=(h=t.actions)==null?void 0:h.find(W=>W.action==="RETURN_ITEM");return{item_id:t.id,variant_id:t.variant_id,quantity:t.detail.return_requested_quantity,note:d==null?void 0:d.internal_note,reason_id:(M=d==null?void 0:d.details)==null?void 0:M.reason_id}}),outbound_items:B.map(t=>({item_id:t.id,variant_id:t.variant_id,quantity:t.detail.quantity})),inbound_option_id:s?s.shipping_option_id:"",outbound_option_id:i?i.shipping_option_id:"",location_id:r==null?void 0:r.location_id,send_notification:!1})},resolver:ut(jt)}),x=l.shipping_methods.find(s=>{var i;return!!((i=s.actions)!=null&&i.find(t=>t.action==="SHIPPING_ADD"&&!!t.return_id))}),c=l.shipping_methods.find(s=>{var i;return!!((i=s.actions)!=null&&i.find(t=>t.action==="SHIPPING_ADD"&&!t.return_id))});j.useEffect(()=>{x&&w(x.total)},[x]),j.useEffect(()=>{c&&k(c.total)},[c]);const _=p.watch("inbound_option_id"),y=p.watch("outbound_option_id"),A=_t(),D=p.handleSubmit(async s=>{try{if(!await A({title:a("general.areYouSure"),description:a("orders.exchanges.confirmText"),confirmText:a("actions.continue"),cancelText:a("actions.cancel"),variant:"confirmation"}))return;await f({no_notification:!s.send_notification}),m()}catch(i){R.error(a("general.error"),{description:i.message})}});j.useEffect(()=>{var s;g&&((s=document.getElementById("js-inbound-shipping-input"))==null||s.focus())},[g]),j.useEffect(()=>{var s;v&&((s=document.getElementById("js-outbound-shipping-input"))==null||s.focus())},[v]),j.useEffect(()=>()=>{re&&(E(void 0,{onSuccess:()=>{R.success(a("orders.exchanges.actions.cancelExchange.successToast"))},onError:s=>{R.error(s.message)}}),re=!1)},[]);const u=j.useMemo(()=>{const s=l.shipping_methods.find(i=>{var t;return!!((t=i.actions)!=null&&t.find(d=>d.action==="SHIPPING_ADD"&&!!d.return_id))});return(s==null?void 0:s.total)||0},[l.shipping_methods]);return e.jsx(X.Form,{form:p,children:e.jsxs(xt,{onSubmit:D,className:"flex h-full flex-col",children:[e.jsx(X.Header,{}),e.jsx(X.Body,{className:"flex size-full justify-center overflow-y-auto",children:e.jsxs("div",{className:"mt-16 w-[720px] max-w-[100%] px-4 md:p-0",children:[e.jsx(ce,{level:"h1",children:a("orders.exchanges.create")}),e.jsx(Ct,{form:p,preview:l,order:n,exchange:o,orderReturn:r}),e.jsx(Dt,{form:p,preview:l,order:n,exchange:o}),e.jsxs("div",{className:"mt-8 border-y border-dotted py-4",children:[e.jsxs("div",{className:"mb-2 flex items-center justify-between",children:[e.jsx("span",{className:"txt-small text-ui-fg-subtle",children:a("orders.returns.inboundTotal")}),e.jsx("span",{className:"txt-small text-ui-fg-subtle",children:K(z.reduce((s,i)=>{var d;const t=(d=i.actions)==null?void 0:d.find(h=>h.action==="RETURN_ITEM");return s=s+((t==null?void 0:t.amount)||0),s},0)*-1,n.currency_code)})]}),e.jsxs("div",{className:"mb-2 flex items-center justify-between",children:[e.jsx("span",{className:"txt-small text-ui-fg-subtle",children:a("orders.exchanges.outboundTotal")}),e.jsx("span",{className:"txt-small text-ui-fg-subtle",children:K(B.reduce((s,i)=>{var d;const t=(d=i.actions)==null?void 0:d.find(h=>h.action==="ITEM_ADD");return s=s+((t==null?void 0:t.amount)||0),s},0),n.currency_code)})]}),e.jsxs("div",{className:"mb-2 flex items-center justify-between",children:[e.jsx("span",{className:"txt-small text-ui-fg-subtle",children:a("orders.returns.inboundShipping")}),e.jsxs("span",{className:"txt-small text-ui-fg-subtle flex items-center",children:[!g&&e.jsx(ee,{onClick:()=>N(!0),variant:"transparent",className:"text-ui-fg-muted",disabled:!(z!=null&&z.length)||!_,children:e.jsx(he,{})}),g?e.jsx(fe,{id:"js-inbound-shipping-input",onBlur:()=>{let s;l.shipping_methods.forEach(t=>{if(t.actions)for(const d of t.actions)d.action==="SHIPPING_ADD"&&d.return_id&&(s=d.id)});const i=P===""?null:parseFloat(P);s&&H({actionId:s,custom_amount:i},{onError:t=>{R.error(t.message)}}),N(!1)},symbol:pe[n.currency_code.toUpperCase()].symbol_native,code:n.currency_code,onValueChange:w,value:P,disabled:!(z!=null&&z.length)}):K(u,n.currency_code)]})]}),e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsx("span",{className:"txt-small text-ui-fg-subtle",children:a("orders.exchanges.outboundShipping")}),e.jsxs("span",{className:"txt-small text-ui-fg-subtle flex items-center",children:[!v&&e.jsx(ee,{onClick:()=>S(!0),variant:"transparent",className:"text-ui-fg-muted",disabled:!(B!=null&&B.length)||!y,children:e.jsx(he,{})}),v?e.jsx(fe,{id:"js-outbound-shipping-input",onBlur:()=>{let s;l.shipping_methods.forEach(t=>{if(t.actions)for(const d of t.actions)d.action==="SHIPPING_ADD"&&!d.return_id&&(s=d.id)});const i=T===""?null:parseFloat(T);s&&q({actionId:s,custom_amount:i},{onError:t=>{R.error(t.message)}}),S(!1)},symbol:pe[n.currency_code.toUpperCase()].symbol_native,code:n.currency_code,onValueChange:k,value:T,disabled:!(B!=null&&B.length)}):K((c==null?void 0:c.amount)??0,n.currency_code)]})]}),e.jsxs("div",{className:"mt-4 flex items-center justify-between border-t border-dotted pt-4",children:[e.jsx("span",{className:"txt-small font-medium",children:a("orders.exchanges.refundAmount")}),e.jsx("span",{className:"txt-small font-medium",children:K(l.summary.pending_difference,n.currency_code)})]})]}),e.jsx("div",{className:"bg-ui-bg-field mt-8 rounded-lg border py-2 pl-2 pr-4",children:e.jsx(b.Field,{control:p.control,name:"send_notification",render:({field:{onChange:s,value:i,...t}})=>e.jsxs(b.Item,{children:[e.jsxs("div",{className:"flex items-center",children:[e.jsx(b.Control,{className:"mr-4 self-start",children:e.jsx(mt,{className:"mt-[2px]",checked:!!i,onCheckedChange:s,...t})}),e.jsxs("div",{className:"block",children:[e.jsx(b.Label,{children:a("orders.returns.sendNotification")}),e.jsx(b.Hint,{className:"!mt-1",children:a("orders.returns.sendNotificationHint")})]})]}),e.jsx(b.ErrorMessage,{})]})})}),e.jsx("div",{className:"p-8"})]})}),e.jsx(X.Footer,{children:e.jsx("div",{className:"flex w-full items-center justify-end gap-x-4",children:e.jsxs("div",{className:"flex items-center justify-end gap-x-2",children:[e.jsx(X.Close,{asChild:!0,children:e.jsx(Z,{type:"button",onClick:()=>re=!0,variant:"secondary",size:"small",children:a("orders.exchanges.cancel.title")})}),e.jsx(Z,{type:"submit",variant:"primary",size:"small",isLoading:C,children:a("orders.exchanges.confirm")},"submit-button")]})})})]})})},le=!1,Cs=()=>{const{id:n}=ot(),l=rt(),{t:o}=V(),{order:r}=lt(n,{fields:nt}),{order:a}=dt(n),[m,g]=j.useState(),{mutateAsync:N}=ze(r.id),{exchange:v}=Be(m,void 0,{enabled:!!m}),{return:S}=it(v==null?void 0:v.return_id,void 0,{enabled:!!(v!=null&&v.return_id)});return j.useEffect(()=>{async function P(){if(!(le||!a)){if(a.order_change){a.order_change.change_type==="exchange"?g(a.order_change.exchange_id):(l(`/orders/${a.id}`,{replace:!0}),R.error(o("orders.exchanges.activeChangeError")));return}le=!0;try{const{exchange:w}=await N({order_id:a.id});g(w.id)}catch(w){R.error(w.message),l(`/orders/${a.id}`,{replace:!0})}finally{le=!1}}}P()},[a]),e.jsx(X,{children:v&&a&&r&&e.jsx(Rt,{order:r,exchange:v,preview:a,orderReturn:S})})};export{Cs as Component};
