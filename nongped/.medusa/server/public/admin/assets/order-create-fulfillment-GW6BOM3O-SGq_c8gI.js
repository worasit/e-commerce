import{g as N}from"./chunk-WKOPGFW5-Di_6cJlP.js";import{a5 as j,R as M,a6 as k,aK as T,j as e,b as S,b7 as V,aW as A,r as _,a8 as Q,a9 as L,b8 as O,t as C,v as R,w as l,ab as $,B as E,a7 as H,aZ as P,T as I,x as z}from"./index-CJZ0utKv.js";import{K as B}from"./chunk-6HTZNHPT-DAtm5oB_.js";import{R as v,u as K}from"./chunk-KL22UNUW-BusAggzY.js";import{S as y}from"./select-D6d_583H.js";import{A as D}from"./alert-B1fSnlBT.js";import"./prompt-Di3JszOJ.js";import"./triangles-mini-CxMQ-XTT.js";import"./x-mark-mini-ysYOSGAt.js";var W=j.object({quantity:j.record(j.string(),j.number()),location_id:j.string(),shipping_option_id:j.string().optional(),send_notification:j.boolean().optional()});function G({item:t,form:o,locationId:a,itemReservedQuantitiesMap:x}){const{t:d}=S(),{variant:f}=H(t.product_id,t.variant_id,{fields:"*inventory,*inventory.location_levels"},{enabled:!!t.variant}),{availableQuantity:h,inStockQuantity:p}=_.useMemo(()=>{var w,F;if(!f||!a)return{};const{inventory:i}=f,n=(F=(w=i[0])==null?void 0:w.location_levels)==null?void 0:F.find(s=>s.location_id===a);if(!n)return{};const u=x.get(t.id)??0;return{availableQuantity:n.available_quantity+u,inStockQuantity:n.stocked_quantity}},[f,a,x]),b=0,g=Math.min(N(t),h||Number.MAX_SAFE_INTEGER);return e.jsx("div",{className:"bg-ui-bg-subtle shadow-elevation-card-rest my-2 rounded-xl ",children:e.jsxs("div",{className:"flex flex-col gap-x-2 gap-y-2 border-b p-3 text-sm sm:flex-row",children:[e.jsxs("div",{className:"flex flex-1 items-center gap-x-3",children:[e.jsx(P,{src:t.thumbnail}),e.jsxs("div",{className:"flex flex-col",children:[e.jsxs("div",{children:[e.jsx(I,{className:"txt-small",as:"span",weight:"plus",children:t.title}),t.variant_sku&&e.jsxs("span",{children:["(",t.variant_sku,")"]})]}),e.jsx(I,{as:"div",className:"text-ui-fg-subtle txt-small",children:t.variant_title})]})]}),e.jsxs("div",{className:"flex flex-1 items-center gap-x-1",children:[e.jsx("div",{className:"mr-2 block h-[16px] w-[2px] bg-gray-200"}),e.jsxs("div",{className:"text-small flex flex-1 flex-col",children:[e.jsx("span",{className:"text-ui-fg-subtle font-medium",children:d("orders.fulfillment.available")}),e.jsx("span",{className:"text-ui-fg-subtle",children:h||"N/A"})]}),e.jsxs("div",{className:"flex flex-1 items-center gap-x-1",children:[e.jsx("div",{className:"mr-2 block h-[16px] w-[2px] bg-gray-200"}),e.jsxs("div",{className:"flex flex-col",children:[e.jsx("span",{className:"text-ui-fg-subtle font-medium",children:d("orders.fulfillment.inStock")}),e.jsxs("span",{className:"text-ui-fg-subtle",children:[p||"N/A"," ",p&&e.jsxs("span",{className:"font-medium text-red-500",children:["-",o.getValues(`quantity.${t.id}`)]})]})]})]}),e.jsxs("div",{className:"flex flex-1 items-center gap-1",children:[e.jsx(l.Field,{control:o.control,name:`quantity.${t.id}`,rules:{required:!0,min:b,max:g},render:({field:i})=>e.jsxs(l.Item,{children:[e.jsx(l.Control,{children:e.jsx(z,{className:"bg-ui-bg-base txt-small w-[50px] rounded-lg text-right [appearance:textfield] [&::-webkit-inner-spin-button]:appearance-none [&::-webkit-outer-spin-button]:appearance-none",type:"number",...i,onChange:n=>{const u=n.target.value===""?null:Number(n.target.value);i.onChange(u),isNaN(u)||(u<b||u>g?o.setError(`quantity.${t.id}`,{type:"manual",message:d("orders.fulfillment.error.wrongQuantity",{count:g,number:g})}):o.clearErrors(`quantity.${t.id}`))}})}),e.jsx(l.ErrorMessage,{})]})}),e.jsxs("span",{className:"text-ui-fg-subtle",children:["/ ",t.quantity," ",d("fields.qty")]})]})]})]})})}function X({order:t,requiresShipping:o}){const{t:a}=S(),{handleSuccess:x}=K(),{mutateAsync:d,isPending:f}=V(t.id),{reservations:h}=A({line_item_id:t.items.map(s=>s.id)}),p=_.useMemo(()=>new Map((h||[]).map(s=>[s.line_item_id,s.quantity])),[h]),[b,g]=_.useState(()=>(t.items||[]).filter(s=>s.requires_shipping===o&&N(s)>0)),i=Q({defaultValues:{quantity:b.reduce((s,r)=>(s[r.id]=N(r),s),{}),send_notification:!t.no_notification},resolver:L(W)}),{stock_locations:n=[]}=O(),u=i.handleSubmit(async s=>{try{await d({location_id:s.location_id,no_notification:!s.send_notification,items:Object.entries(s.quantity).filter(([,r])=>!!r).map(([r,m])=>({id:r,quantity:m}))}),C.success(a("orders.fulfillment.toast.created")),x(`/orders/${t.id}`)}catch(r){C.error(r.message)}});_.useEffect(()=>{n!=null&&n.length&&i.setValue("location_id",n[0].id)},[n==null?void 0:n.length]);const w=R({name:"location_id",control:i.control}),F=(t.items||[]).map(s=>s.requires_shipping===o&&s.detail.fulfilled_quantity);return _.useEffect(()=>{var m;const s=((m=t==null?void 0:t.items)==null?void 0:m.filter(c=>c.requires_shipping===o&&N(c)>0))||[];g(s),s.length?i.clearErrors("root"):i.setError("root",{type:"manual",message:a("orders.fulfillment.error.noItems")});const r=s.reduce((c,q)=>(c[q.id]=N(q),c),{});i.setValue("quantity",r)},[...F,o]),e.jsx(v.Form,{form:i,children:e.jsxs(B,{onSubmit:u,className:"flex h-full flex-col overflow-hidden",children:[e.jsx(v.Header,{}),e.jsx(v.Body,{className:"flex h-full w-full flex-col items-center divide-y overflow-y-auto",children:e.jsx("div",{className:"flex size-full flex-col items-center overflow-auto p-16",children:e.jsx("div",{className:"flex w-full max-w-[736px] flex-col justify-center px-2 pb-2",children:e.jsxs("div",{className:"flex flex-col divide-y divide-dashed",children:[e.jsx("div",{className:"pb-8",children:e.jsx(l.Field,{control:i.control,name:"location_id",render:({field:{onChange:s,ref:r,...m}})=>e.jsxs(l.Item,{children:[e.jsxs("div",{className:"flex flex-col gap-2 xl:flex-row xl:items-center",children:[e.jsxs("div",{className:"flex-1",children:[e.jsx(l.Label,{children:a("fields.location")}),e.jsx(l.Hint,{children:a("orders.fulfillment.locationDescription")})]}),e.jsx("div",{className:"flex-1",children:e.jsx(l.Control,{children:e.jsxs(y,{onValueChange:s,...m,children:[e.jsx(y.Trigger,{className:"bg-ui-bg-base",ref:r,children:e.jsx(y.Value,{})}),e.jsx(y.Content,{children:n.map(c=>e.jsx(y.Item,{value:c.id,children:c.name},c.id))})]})})})]}),e.jsx(l.ErrorMessage,{})]})})}),e.jsxs("div",{children:[e.jsxs(l.Item,{className:"mt-8",children:[e.jsx(l.Label,{children:a("orders.fulfillment.itemsToFulfill")}),e.jsx(l.Hint,{children:a("orders.fulfillment.itemsToFulfillDesc")}),e.jsx("div",{className:"flex flex-col gap-y-1",children:b.map(s=>e.jsx(G,{form:i,item:s,locationId:w,itemReservedQuantitiesMap:p},s.id))})]}),i.formState.errors.root&&e.jsx(D,{variant:"error",dismissible:!1,className:"flex items-center",classNameInner:"flex justify-between flex-1 items-center",children:i.formState.errors.root.message})]}),e.jsx("div",{className:"mt-8 pt-8 ",children:e.jsx(l.Field,{control:i.control,name:"send_notification",render:({field:{onChange:s,value:r,...m}})=>e.jsxs(l.Item,{children:[e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsx(l.Label,{children:a("orders.returns.sendNotification")}),e.jsx(l.Control,{children:e.jsx(l.Control,{children:e.jsx($,{checked:!!r,onCheckedChange:s,...m})})})]}),e.jsx(l.Hint,{className:"!mt-1",children:a("orders.fulfillment.sendNotificationHint")}),e.jsx(l.ErrorMessage,{})]})})})]})})})}),e.jsx(v.Footer,{children:e.jsxs("div",{className:"flex items-center justify-end gap-x-2",children:[e.jsx(v.Close,{asChild:!0,children:e.jsx(E,{size:"small",variant:"secondary",children:a("actions.cancel")})}),e.jsx(E,{size:"small",type:"submit",isLoading:f,children:a("orders.fulfillment.create")})]})})]})})}function ae(){const{id:t}=M(),[o]=k(),a=o.get("requires_shipping")==="true",{order:x,isLoading:d,isError:f,error:h}=T(t,{fields:"currency_code,*items,*items.variant,*shipping_address"});if(f)throw h;const p=!d&&x;return e.jsx(v,{children:p&&e.jsx(X,{order:x,requiresShipping:a})})}export{ae as Component};
