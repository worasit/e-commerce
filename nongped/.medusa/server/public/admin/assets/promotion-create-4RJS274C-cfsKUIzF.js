import{R as T}from"./chunk-UDMIPTZG-DDK4JI2m.js";import{C as le,D as Q}from"./chunk-IBOUGGPG-CnHwB59k.js";import{a5 as i,j as e,r as _,b as ce,a8 as de,a9 as me,dn as pe,t as I,v as f,dp as ue,w as a,H as he,Y as xe,m as u,x as W,T as q,D as A,B}from"./index-CJZ0utKv.js";import{D as fe}from"./chunk-YRY2CZ6I-KsZFjwUt.js";import{A as ge}from"./chunk-TJ3XW5AO-CArku32s.js";import{g as ye}from"./chunk-MWVM4TYO-bKUcYSnf.js";import"./chunk-BNH57GBH-aOoD9B19.js";import{K as _e}from"./chunk-6HTZNHPT-DAtm5oB_.js";import{R as g,u as je}from"./chunk-KL22UNUW-BusAggzY.js";import{T as E}from"./Trans-CyKh6hGN.js";import{P as h}from"./progress-tabs-xF6bypyH.js";import{R as d}from"./radio-group-B0rUunxU.js";import{A as be}from"./alert-B1fSnlBT.js";import{C as ve}from"./currency-input-BHCL_9VI.js";import"./x-mark-mini-ysYOSGAt.js";import"./select-D6d_583H.js";import"./triangles-mini-CxMQ-XTT.js";import"./chunk-F6ZOHZVB-RC8RLU0U.js";import"./chunk-RX6DOG6Q-DNeHiIRJ.js";import"./textarea-CySGJxgJ.js";import"./date-picker-Celg6WpL.js";import"./clsx-B-dksMZM.js";import"./popover-Dq5pafWl.js";import"./index-poKGl5ZU.js";import"./triangle-left-mini-DJxp3gb4.js";import"./index.esm-Ls_FBjZZ.js";import"./plus-mini-BdX2C9J6.js";import"./prompt-Di3JszOJ.js";var z=i.array(i.object({id:i.string().optional(),attribute:i.string().min(1,{message:"Required field"}),operator:i.string().min(1,{message:"Required field"}),values:i.union([i.number().min(1,{message:"Required field"}),i.string().min(1,{message:"Required field"}),i.array(i.string()).min(1,{message:"Required field"})]),required:i.boolean().optional(),disguised:i.boolean().optional(),field_type:i.string().optional()})),Ce=i.object({template_id:i.string().optional(),campaign_id:i.string().optional(),campaign_choice:i.enum(["none","existing","new"]).optional(),is_automatic:i.string().toLowerCase(),code:i.string().min(1),type:i.enum(["buyget","standard"]),rules:z,application_method:i.object({allocation:i.enum(["each","across"]),value:i.number().min(0),currency_code:i.string().optional(),max_quantity:i.number().optional().nullable(),target_rules:z,buy_rules:z,type:i.enum(["fixed","percentage"]),target_type:i.enum(["order","shipping_methods","items"])}),campaign:le.optional()}).refine(x=>x.application_method.allocation==="across"?!0:x.application_method.allocation==="each"&&typeof x.application_method.max_quantity=="number",{path:["application_method.max_quantity"],message:"required field"}),j=["type","application_method.type","application_method.allocation"],M=[{id:"amount_off_products",type:"standard",title:"Amount off products",description:"Discount specific products or collection of products",hiddenFields:[...j],defaults:{is_automatic:"false",type:"standard",application_method:{allocation:"each",target_type:"items",type:"fixed"}}},{id:"amount_off_order",type:"standard",title:"Amount off order",description:"Discounts the total order amount",hiddenFields:[...j],defaults:{is_automatic:"false",type:"standard",application_method:{allocation:"across",target_type:"order",type:"fixed"}}},{id:"percentage_off_product",type:"standard",title:"Percentage off product",description:"Discounts a percentage off selected products",hiddenFields:[...j],defaults:{is_automatic:"false",type:"standard",application_method:{allocation:"each",target_type:"items",type:"percentage"}}},{id:"percentage_off_order",type:"standard",title:"Percentage off order",description:"Discounts a percentage of the total order amount",hiddenFields:[...j],defaults:{is_automatic:"false",type:"standard",application_method:{allocation:"across",target_type:"order",type:"percentage"}}},{id:"buy_get",type:"buy_get",title:"Buy X Get Y",description:"Buy X product(s), get Y product(s)",hiddenFields:[...j,"application_method.value"],defaults:{is_automatic:"false",type:"buyget",application_method:{type:"percentage",value:100,apply_to_quantity:1,max_quantity:1}}}],J={campaign_id:void 0,template_id:M[0].id,campaign_choice:"none",is_automatic:"false",code:"",type:"standard",rules:[],application_method:{allocation:"each",type:"fixed",target_type:"items",max_quantity:1,target_rules:[],buy_rules:[]},campaign:void 0},Ne=()=>{var K,H,O,U;const[x,b]=_.useState("type"),[w,v]=_.useState({type:"in-progress",promotion:"not-started",campaign:"not-started"}),{t:s}=ce(),{handleSuccess:Z}=je(),o=de({defaultValues:J,resolver:me(Ce)}),{mutateAsync:ee}=pe(),te=o.handleSubmit(async t=>{const{campaign_choice:r,is_automatic:n,template_id:m,application_method:p,rules:G,...ie}=t,{target_rules:Y=[],buy_rules:$=[],...re}=p,ne=[...Y.filter(c=>!!c.disguised),...$.filter(c=>!!c.disguised),...G.filter(c=>!!c.disguised)],X={};for(const c of ne)X[c.attribute]=c.field_type==="number"?parseInt(c.values):c.values;const S=c=>c.filter(y=>!y.disguised).map(y=>({operator:y.operator,attribute:y.attribute,values:y.values}));ee({...ie,rules:S(G),application_method:{...re,...X,target_rules:S(Y),buy_rules:S($)},is_automatic:n==="true"},{onSuccess:({promotion:c})=>{I.success(s("promotions.toasts.promotionCreateSuccess",{code:c.code})),Z()},onError:c=>{I.error(c.message)}})},async t=>{const{campaign:r,...n}=t||{};!!Object.keys(n||{}).length&&I.error(s("promotions.errors.promotionTabError"))}),F=async t=>{switch(t){case"type":v(r=>({...r,type:"in-progress"})),b(t);break;case"promotion":v(r=>({...r,type:"completed",promotion:"in-progress"})),b(t);break;case"campaign":{if(!await o.trigger()){v({type:"completed",promotion:"in-progress",campaign:"not-started"}),b("promotion");break}v(n=>({...n,promotion:"completed",campaign:"in-progress"})),b(t);break}}},oe=async()=>{switch(x){case"type":F("promotion");break;case"promotion":{await o.trigger()&&F("campaign");break}}},V=f({control:o.control,name:"template_id"}),l=_.useMemo(()=>{const t=M.find(r=>r.id===V);if(t){o.reset({...J,template_id:V});for(const[r,n]of Object.entries(t.defaults))if(typeof n=="object")for(const[m,p]of Object.entries(n))o.setValue(`application_method.${m}`,p);else o.setValue(r,n);return t}},[V]),C=f({control:o.control,name:"application_method.type"})==="fixed",R=f({control:o.control,name:"application_method.allocation"});_.useEffect(()=>{R==="across"&&o.setValue("application_method.max_quantity",null)},[R]);const D=f({control:o.control,name:"type"})==="standard",ae=f({control:o.control,name:"application_method.target_type"})==="order",P=o.getValues();let L={};C&&P.application_method.currency_code&&(L={budget:{currency_code:P.application_method.currency_code}});const{campaigns:se}=ue(L),N=f({control:o.control,name:"campaign_choice"});_.useEffect(()=>{var r,n;const t=o.getValues();N!=="existing"&&o.setValue("campaign_id",void 0),N!=="new"&&o.setValue("campaign",void 0),N==="new"&&(!t.campaign||!((n=(r=t.campaign)==null?void 0:r.budget)!=null&&n.type))&&o.setValue("campaign",{...Q,budget:{...Q.budget,currency_code:t.application_method.currency_code}})},[N]);const k=f({control:o.control,name:"rules"}).find(t=>t.attribute==="currency_code");if(k){const r=o.getValues().application_method.currency_code,n=k.values;!Array.isArray(n)&&r!==n&&o.setValue("application_method.currency_code",n)}return e.jsx(g.Form,{form:o,children:e.jsxs(_e,{className:"flex h-full flex-col",onSubmit:te,children:[e.jsxs(h,{value:x,onValueChange:t=>F(t),className:"flex h-full flex-col overflow-hidden",children:[e.jsx(g.Header,{children:e.jsx("div",{className:"flex w-full items-center justify-between gap-x-4",children:e.jsx("div",{className:"-my-2 w-full max-w-[600px] border-l",children:e.jsxs(h.List,{className:"grid w-full grid-cols-3",children:[e.jsx(h.Trigger,{className:"w-full",value:"type",status:w.type,children:s("promotions.tabs.template")}),e.jsx(h.Trigger,{className:"w-full",value:"promotion",status:w.promotion,children:s("promotions.tabs.details")}),e.jsx(h.Trigger,{className:"w-full",value:"campaign",status:w.campaign,children:s("promotions.tabs.campaign")})]})})})}),e.jsxs(g.Body,{className:"size-full overflow-hidden",children:[e.jsx(h.Content,{value:"type",className:"size-full overflow-y-auto",children:e.jsx("div",{className:"flex size-full flex-col items-center",children:e.jsx("div",{className:"w-full max-w-[720px] py-16",children:e.jsx(a.Field,{control:o.control,name:"template_id",render:({field:t})=>e.jsxs(a.Item,{children:[e.jsx(a.Label,{children:s("promotions.fields.type")}),e.jsx(a.Control,{children:e.jsx(d,{className:"flex-col gap-y-3",...t,onValueChange:t.onChange,children:M.map(r=>e.jsx(d.ChoiceBox,{value:r.id,label:r.title,description:r.description},r.id))},"template_id")}),e.jsx(a.ErrorMessage,{})]})})})})}),e.jsx(h.Content,{value:"promotion",className:"size-full overflow-y-auto",children:e.jsx("div",{className:"flex size-full flex-col items-center",children:e.jsxs("div",{className:"flex w-full max-w-[720px] flex-col gap-y-8 py-16",children:[e.jsxs(he,{level:"h1",className:"text-fg-base",children:[s("promotions.sections.details"),(l==null?void 0:l.title)&&e.jsx(xe,{className:"ml-2 align-middle",color:"grey",size:"2xsmall",rounded:"full",children:l==null?void 0:l.title})]}),o.formState.errors.root&&e.jsx(be,{variant:"error",dismissible:!1,className:"text-balance",children:o.formState.errors.root.message}),e.jsx(a.Field,{control:o.control,name:"is_automatic",render:({field:t})=>e.jsxs(a.Item,{children:[e.jsx(a.Label,{children:s("promotions.form.method.label")}),e.jsx(a.Control,{children:e.jsxs(d,{className:"flex gap-y-3",...t,value:t.value,onValueChange:t.onChange,children:[e.jsx(d.ChoiceBox,{value:"false",label:s("promotions.form.method.code.title"),description:s("promotions.form.method.code.description"),className:u("basis-1/2")}),e.jsx(d.ChoiceBox,{value:"true",label:s("promotions.form.method.automatic.title"),description:s("promotions.form.method.automatic.description"),className:u("basis-1/2")})]})}),e.jsx(a.ErrorMessage,{})]})}),e.jsx("div",{className:"flex gap-y-4",children:e.jsx(a.Field,{control:o.control,name:"code",render:({field:t})=>e.jsxs(a.Item,{className:"basis-1/2",children:[e.jsx(a.Label,{children:s("promotions.form.code.title")}),e.jsx(a.Control,{children:e.jsx(W,{...t,placeholder:"SUMMER15"})}),e.jsx(q,{size:"small",leading:"compact",className:"text-ui-fg-subtle",children:e.jsx(E,{t:s,i18nKey:"promotions.form.code.description",components:[e.jsx("br",{},"break")]})})]})})}),!((K=l==null?void 0:l.hiddenFields)!=null&&K.includes("type"))&&e.jsx(a.Field,{control:o.control,name:"type",render:({field:t})=>e.jsxs(a.Item,{children:[e.jsx(a.Label,{children:s("promotions.fields.type")}),e.jsx(a.Control,{children:e.jsxs(d,{className:"flex gap-y-3",...t,onValueChange:t.onChange,children:[e.jsx(d.ChoiceBox,{value:"standard",label:s("promotions.form.type.standard.title"),description:s("promotions.form.type.standard.description"),className:u("basis-1/2")}),e.jsx(d.ChoiceBox,{value:"buyget",label:s("promotions.form.type.buyget.title"),description:s("promotions.form.type.buyget.description"),className:u("basis-1/2")})]})}),e.jsx(a.ErrorMessage,{})]})}),e.jsx(A,{}),e.jsx(T,{form:o,ruleType:"rules"}),e.jsx(A,{}),!((H=l==null?void 0:l.hiddenFields)!=null&&H.includes("application_method.type"))&&e.jsx(a.Field,{control:o.control,name:"application_method.type",render:({field:t})=>e.jsxs(a.Item,{children:[e.jsx(a.Label,{children:s("promotions.fields.value_type")}),e.jsx(a.Control,{children:e.jsxs(d,{className:"flex gap-y-3",...t,onValueChange:t.onChange,children:[e.jsx(d.ChoiceBox,{value:"fixed",label:s("promotions.form.value_type.fixed.title"),description:s("promotions.form.value_type.fixed.description"),className:u("basis-1/2")}),e.jsx(d.ChoiceBox,{value:"percentage",label:s("promotions.form.value_type.percentage.title"),description:s("promotions.form.value_type.percentage.description"),className:u("basis-1/2")})]})}),e.jsx(a.ErrorMessage,{})]})}),e.jsxs("div",{className:"flex gap-x-2 gap-y-4",children:[!((O=l==null?void 0:l.hiddenFields)!=null&&O.includes("application_method.value"))&&e.jsx(a.Field,{control:o.control,name:"application_method.value",render:({field:{onChange:t,value:r,...n}})=>{const m=o.getValues().application_method.currency_code;return e.jsxs(a.Item,{className:"basis-1/2",children:[e.jsx(a.Label,{tooltip:m||!C?void 0:s("promotions.fields.amount.tooltip"),children:s("promotions.form.value.title")}),e.jsx(a.Control,{children:C?e.jsx(ve,{...n,min:0,onValueChange:p=>{t(p?parseInt(p):"")},code:m||"USD",symbol:m?ye(m):"$",value:r,disabled:!m}):e.jsx(fe,{className:"text-right",min:0,max:100,...n,value:r,onChange:p=>{t(p.target.value===""?null:parseInt(p.target.value))}},"amount")}),e.jsx(q,{size:"small",leading:"compact",className:"text-ui-fg-subtle",children:e.jsx(E,{t:s,i18nKey:C?"promotions.form.value_type.fixed.description":"promotions.form.value_type.percentage.description",components:[e.jsx("br",{},"break")]})}),e.jsx(a.ErrorMessage,{})]})}}),D&&R==="each"&&e.jsx(a.Field,{control:o.control,name:"application_method.max_quantity",render:({field:t})=>e.jsxs(a.Item,{className:"basis-1/2",children:[e.jsx(a.Label,{children:s("promotions.form.max_quantity.title")}),e.jsx(a.Control,{children:e.jsx(W,{...o.register("application_method.max_quantity",{valueAsNumber:!0}),type:"number",min:1,placeholder:"3"})}),e.jsx(q,{size:"small",leading:"compact",className:"text-ui-fg-subtle",children:e.jsx(E,{t:s,i18nKey:"promotions.form.max_quantity.description",components:[e.jsx("br",{},"break")]})})]})})]}),D&&!((U=l==null?void 0:l.hiddenFields)!=null&&U.includes("application_method.allocation"))&&e.jsx(a.Field,{control:o.control,name:"application_method.allocation",render:({field:t})=>e.jsxs(a.Item,{children:[e.jsx(a.Label,{children:s("promotions.fields.allocation")}),e.jsx(a.Control,{children:e.jsxs(d,{className:"flex gap-y-3",...t,onValueChange:t.onChange,children:[e.jsx(d.ChoiceBox,{value:"each",label:s("promotions.form.allocation.each.title"),description:s("promotions.form.allocation.each.description"),className:u("basis-1/2")}),e.jsx(d.ChoiceBox,{value:"across",label:s("promotions.form.allocation.across.title"),description:s("promotions.form.allocation.across.description"),className:u("basis-1/2")})]})}),e.jsx(a.ErrorMessage,{})]})}),!D&&e.jsx(e.Fragment,{children:e.jsx(T,{form:o,ruleType:"buy-rules",scope:"application_method.buy_rules"})}),!ae&&e.jsxs(e.Fragment,{children:[e.jsx(A,{}),e.jsx(T,{form:o,ruleType:"target-rules",scope:"application_method.target_rules"})]})]})})}),e.jsx(h.Content,{value:"campaign",className:"size-full overflow-auto",children:e.jsx("div",{className:"flex flex-col items-center",children:e.jsx("div",{className:"flex w-full max-w-[720px] flex-col gap-y-8 py-16",children:e.jsx(ge,{form:o,campaigns:se||[]})})})})]})]}),e.jsx(g.Footer,{children:e.jsxs("div",{className:"flex items-center justify-end gap-x-2",children:[e.jsx(g.Close,{asChild:!0,children:e.jsx(B,{variant:"secondary",size:"small",children:s("actions.cancel")})}),x==="campaign"?e.jsx(B,{type:"submit",size:"small",isLoading:!1,children:s("actions.save")},"save-btn"):e.jsx(B,{type:"button",onClick:oe,size:"small",children:s("actions.continue")},"continue-btn")]})})]})})},at=()=>e.jsx(g,{children:e.jsx(Ne,{})});export{at as Component};
