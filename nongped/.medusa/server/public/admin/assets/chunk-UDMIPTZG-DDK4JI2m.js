import{C as G}from"./chunk-BNH57GBH-aOoD9B19.js";import{b as J,dq as K,y as Q,v as k,dr as U,r as P,j as e,H as Z,T as O,w as r,Y as R,B,g as ee,ds as se,x as L}from"./index-CJZ0utKv.js";import{X as ae}from"./x-mark-mini-ysYOSGAt.js";import{S as d}from"./select-D6d_583H.js";var A=i=>(i||[]).map(s=>{var x,g;return{id:s.id,required:s.required,field_type:s.field_type,disguised:s.disguised,attribute:s.attribute,operator:s.operator,values:s.field_type==="number"||s.operator==="eq"?typeof s.values=="object"?(x=s.values[0])==null?void 0:x.value:s.values:(g=s==null?void 0:s.values)==null?void 0:g.map(b=>b.value)}}),re=(i,s)=>{var x;return!i||!s?{}:i==="currency_code"?{value:(x=s.supported_currencies)==null?void 0:x.map(g=>g.currency_code)}:{}},te=({form:i,identifier:s,scope:x,valuesField:g,operatorsField:b,valuesRef:t,fieldRule:c,attributes:$,ruleType:j})=>{const a=$==null?void 0:$.find(u=>u.value===c.attribute),{store:V,isLoading:q}=ee(),{values:N=[]}=se(j,a==null?void 0:a.id,re(a==null?void 0:a.id,V),{enabled:!!(a!=null&&a.id)&&["select","multiselect"].includes(a.field_type)&&!q}),y=k({control:i.control,name:b.name});return e.jsx(r.Field,{...g,render:({field:{onChange:u,ref:F,...m}})=>(a==null?void 0:a.field_type)==="number"?e.jsxs(r.Item,{className:"basis-1/2",children:[e.jsx(r.Control,{children:e.jsx(L,{...m,type:"number",onChange:u,className:"bg-ui-bg-base",ref:t,min:1,disabled:!c.attribute})}),e.jsx(r.ErrorMessage,{})]}):(a==null?void 0:a.field_type)==="text"?e.jsxs(r.Item,{className:"basis-1/2",children:[e.jsx(r.Control,{children:e.jsx(L,{...m,onChange:u,className:"bg-ui-bg-base",disabled:!c.attribute})}),e.jsx(r.ErrorMessage,{})]}):y==="eq"?e.jsxs(r.Item,{className:"basis-1/2",children:[e.jsx(r.Control,{children:e.jsxs(d,{...m,value:Array.isArray(m.value)?m.value[0]:m.value,onValueChange:u,disabled:!c.attribute,children:[e.jsx(d.Trigger,{ref:F,className:"bg-ui-bg-base",children:e.jsx(d.Value,{placeholder:"Select Value"})}),e.jsx(d.Content,{children:N==null?void 0:N.map((h,C)=>e.jsx(d.Item,{value:h.value,children:e.jsx("span",{className:"text-ui-fg-subtle",children:h.label})},`${s}-value-option-${C}`))})]})}),e.jsx(r.ErrorMessage,{})]}):e.jsxs(r.Item,{className:"basis-1/2",children:[e.jsx(r.Control,{children:e.jsx(G,{...m,placeholder:"Select Values",options:N,onChange:u,className:"bg-ui-bg-base",disabled:!c.attribute})}),e.jsx(r.ErrorMessage,{})]})},`${s}.${x}.${g.name}-${c.attribute}`)},z={id:"product",attribute:"items.product.id",attribute_label:"Product",operator:"eq",operator_label:"Equal",values:[],required:!0,field_type:"select",disguised:!1},ce=({form:i,ruleType:s,setRulesToRemove:x,rulesToRemove:g,scope:b="rules",promotion:t})=>{var S;const{t:c}=J(),$=i.getValues(),{attributes:j}=K(s,$.type),{fields:a,append:V,remove:q,update:N,replace:y}=Q({control:i.control,name:b,keyName:b}),u=k({control:i.control,name:"type",defaultValue:t==null?void 0:t.type}),F=k({control:i.control,name:"application_method.type",defaultValue:(S=t==null?void 0:t.application_method)==null?void 0:S.type}),m=u?{promotion_type:u,application_method_type:F}:{},{rules:h,isLoading:C}=U((t==null?void 0:t.id)||null,s,m,{enabled:!!(t!=null&&t.id)||!!u&&!!F});return P.useEffect(()=>{if(!C){if(s==="rules"&&!a.length&&(i.resetField("rules"),y(A(h))),s==="buy-rules"&&!a.length){i.resetField("application_method.buy_rules");const l=t!=null&&t.id||u==="standard"?h:[...h,z];y(A(l))}if(s==="target-rules"&&!a.length){i.resetField("application_method.target_rules");const l=t!=null&&t.id||u==="standard"?h:[...h,z];y(A(l))}}},[u,C]),e.jsxs("div",{className:"flex flex-col",children:[e.jsx(Z,{level:"h2",className:"mb-2",children:c(`promotions.fields.conditions.${s}.title`)}),e.jsx(O,{className:"text-ui-fg-subtle txt-small mb-6",children:c(`promotions.fields.conditions.${s}.description`)}),a.map((l,o)=>{const p=l.id,{ref:H,...w}=i.register(`${b}.${o}.attribute`),{ref:X,...E}=i.register(`${b}.${o}.operator`),{ref:D,...T}=i.register(`${b}.${o}.values`);return e.jsxs(P.Fragment,{children:[e.jsxs("div",{className:"bg-ui-bg-subtle border-ui-border-base flex flex-row gap-2 rounded-xl border px-2 py-2",children:[e.jsxs("div",{className:"grow",children:[e.jsx(r.Field,{...w,render:({field:{onChange:I,ref:W,...M}})=>{const _=(a==null?void 0:a.map(n=>n.attribute))||[],v=(j==null?void 0:j.filter(n=>n.value===l.attribute?!0:!_.includes(n.value)))||[];return e.jsxs(r.Item,{className:"mb-2",children:[l.required&&e.jsx("p",{className:"text text-ui-fg-muted txt-small",children:c("promotions.form.required")}),e.jsx(r.Control,{children:e.jsxs(d,{...M,onValueChange:n=>{const f=v.find(Y=>Y.id===n);N(o,{...l,values:[],disguised:(f==null?void 0:f.disguised)||!1}),I(n)},disabled:l.required,children:[e.jsx(d.Trigger,{ref:H,className:"bg-ui-bg-base",children:e.jsx(d.Value,{placeholder:c("promotions.form.selectAttribute")})}),e.jsx(d.Content,{children:v==null?void 0:v.map((n,f)=>e.jsx(d.Item,{value:n.value,children:e.jsx("span",{className:"text-ui-fg-subtle",children:n.label})},`${p}-attribute-option-${f}`))})]})}),e.jsx(r.ErrorMessage,{})]})}},`${p}.${b}.${w.name}`),e.jsxs("div",{className:"flex gap-2",children:[e.jsx(r.Field,{...E,render:({field:{onChange:I,ref:W,...M}})=>{var v;const _=j.find(n=>n.value===l.attribute);return e.jsxs(r.Item,{className:"basis-1/2",children:[e.jsx(r.Control,{children:e.jsxs(d,{...M,disabled:!l.attribute,onValueChange:I,children:[e.jsx(d.Trigger,{ref:X,className:"bg-ui-bg-base",children:e.jsx(d.Value,{placeholder:"Select Operator"})}),e.jsx(d.Content,{children:(v=_==null?void 0:_.operators)==null?void 0:v.map((n,f)=>e.jsx(d.Item,{value:n.value,children:e.jsx("span",{className:"text-ui-fg-subtle",children:n.label})},`${p}-operator-option-${f}`))})]})}),e.jsx(r.ErrorMessage,{})]})}},`${p}.${b}.${E.name}`),e.jsx(te,{form:i,identifier:p,scope:b,valuesField:T,operatorsField:E,valuesRef:D,fieldRule:l,attributes:j,ruleType:s})]})]}),e.jsx("div",{className:"flex-none self-center px-1",children:e.jsx(ae,{className:`text-ui-fg-muted cursor-pointer ${l.required?"invisible":"visible"}`,onClick:()=>{l.required||(x&&x([...g,l]),q(o))}})})]}),o<a.length-1&&e.jsxs("div",{className:"relative px-6 py-3",children:[e.jsx("div",{className:"border-ui-border-strong absolute bottom-0 left-[40px] top-0 z-[-1] w-px bg-[linear-gradient(var(--border-strong)_33%,rgba(255,255,255,0)_0%)] bg-[length:1px_3px] bg-repeat-y"}),e.jsx(R,{size:"2xsmall",className:" text-xs",children:c("promotions.form.and")})]})]},`${l.id}.${o}.${l.attribute}`)}),e.jsxs("div",{className:a.length?"mt-6":"",children:[e.jsx(B,{type:"button",variant:"secondary",className:"inline-block",onClick:()=>{V({attribute:"",operator:"",values:[],required:!1})},children:c("promotions.fields.addCondition")}),!!a.length&&e.jsx(B,{type:"button",variant:"transparent",className:"text-ui-fg-muted hover:text-ui-fg-subtle ml-2 inline-block",onClick:()=>{const l=a.map((o,p)=>o.required?null:p).filter(o=>o!==null);x&&x(a.filter(o=>!o.required)),q(l)},children:c("promotions.fields.clearAll")})]})]})};export{ce as R};
